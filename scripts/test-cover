#!/usr/bin/env bash

set -eou pipefail

mkdir -p .cover
touch .cover/merged.out

for D in $(go list ./... | grep -v vendor); do
    COVER_FILE=.cover/$(echo $D | md5sum | sed "s/  -/.out/g") &&
    go test -race -coverprofile=$COVER_FILE $D
done

# merge profiles together, removing results from auto-generated code
gocovmerge .cover/*.out | grep -v '.pb.go:' > .cover/merged.out
