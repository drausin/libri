#!/usr/bin/env bash

set +x

PKGS=$(go list ./...)

mkdir -p .cover

# run test in parallel across packages
echo ${PKGS} | xargs -I {} -n 1 -P 4 bash -c '
    PKG={} &&
    COVER_FILE=.cover/$(echo $PKG | md5sum | sed "s/  -/.out/g") &&
    go test -race $PKG -coverprofile=$COVER_FILE
'
# merge profiles together, removing results from auto-generated code
gocovmerge .cover/*.out | grep -v '.pb.go:' > .cover/merged.out
