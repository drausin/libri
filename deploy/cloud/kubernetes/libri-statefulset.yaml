# later
# - persistent volumes
# - readiness probe
# - lifecycle pre-stop + server graceful stop
# - separate bootstrap StatefulSet/IPs
# - load-balanced endpoint for authors
apiVersion: v1
kind: Service
metadata:
  name: libri
spec:
  ports:
  - port: 20100
    targetPort: 20100
    name: grpc
  clusterIP: None
  selector:
    app: libri
---
apiVersion: apps/v1beta1
kind: StatefulSet
metadata:
  name: librarian
spec:
  serviceName: libri
  replicas: 3
  template:
    metadata:
      labels:
        app: libri
    spec:
      containers:
      - name: libriarian
        image: daedalus2718/resolver:latest
        args: ["librarian-0.libri.default.svc.cluster.local:20100"]
#        imagePullPolicy: Always
#        image: daedalus2718/libri:latest  # develop branch
#        args: ["librarian", "start"]
#        env:
#        - name: LIBRI_BOOTSTRAPS
#          value: "librarian-0.libri.default.svc.cluster.local:20100"
#        - name: LIBRI_PUBLICIP
#          valueFrom:
#            fieldRef:
#              fieldPath: status.podIP
#        - name: LIBRI_DATADIR
#          value: "/librarian-data"
#        ports:
#        - containerPort: 20100
#          name: grpc
#        volumeMounts:
#        - name: librarian-data
#          mountPath: /librarian-data
#    volumeClaimTemplates:
#    - metadata:
#        name: cassandra-data
#        annotations:
#          volume.beta.kubernetes.io/storage-class: fast
#      spec:
#        accessModes: [ "ReadWriteOnce" ]
#        resources:
#          requests:
#            storage: 1Gi
